<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <data>

    <!-- Coordinator Form View -->
    <record id="view_repair_order_form_coordinator" model="ir.ui.view">
      <field name="name">repair.order.form.coordinator</field>
      <field name="model">repair.order</field>
      <field name="inherit_id" ref="repair.view_repair_order_form"/>
      <field name="arch" type="xml">
          
        <!-- Add custom header with state buttons -->
        <xpath expr="//form/header" position="replace">
            <header>
                <!-- Hidden state field -->
                <field name="state" invisible="1"/>
                                
                <!-- <button name="action_send_for_signature"
                        type="object"
                        string="Request Signature"
                        class="btn-primary"
                        invisible="sign_request_id"/>
 -->
                <!-- Start Repair -->
                <button name="action_start_repair"
                        type="object"
                        string="Start Repair"
                        invisible="state not in ('draft','new')"
                        groups="oxord_repair.group_technical_head,base.group_system"
                        confirm="Are you sure you want to start the repair? Have you got permission from the customer?"/>

                <!-- End Repair (trigger wizard) -->
                <button name="action_open_endorse_wizard"
                        type="object"
                        string="Mark as Done"
                        invisible="state != 'under_repair'"
                        groups="oxord_repair.group_technical_head,oxord_repair.group_repair_coordinator,base.group_system"/>

                <!-- Release -->
                <button name="action_release"
                        string="Release"
                        type="object"
                        class="btn-primary"
                        invisible="state != 'done' or not sale_order_id"
                        groups="oxord_repair.group_repair_coordinator,base.group_system"/>


                 <button name="action_create_payment_sale_order"
                        string="Payment"
                        type="object"
                        class="btn-primary"
                        invisible="state != 'done' or sale_order_id"
                        groups="oxord_repair.group_repair_coordinator,base.group_system"/>

                <!-- Cancel -->
                <button name="action_cancel"
                        type="object"
                        string="Cancel"
                        invisible="state in ('done','cancel')"
                        groups="base.group_system"
                        confirm="Are you sure you want to cancel this repair?"/>

                <!-- Reset to Draft -->
                <button name="action_reset_to_draft"
                        type="object"
                        string="Reset to Draft"
                        invisible="state not in ('cancel','done')"
                        groups="base.group_system"/>

                <!-- Print button: last in line -->
                <button name="action_print_claim_form"
                        type="object"
                        string="Print"
                        class="oe_highlight #{print_button_class}"
                        groups="oxord_repair.group_repair_coordinator,base.group_system"/>

                <!-- Re-Repair button -->
                <button name="action_rereturn"
                        type="object"
                        string="Re-Repair"
                        icon="fa-repeat"
                        invisible="state != 'released'"
                        groups="oxord_repair.group_repair_coordinator,base.group_system"/>
                
                <button name="%(oxord_repair.action_technical_report_form)d"
                        string="Create Technical Report"
                        type="action"
                        class="oe_highlight"
                        context="{'default_repair_order_id': id}"
                        groups="oxord_repair.group_technical_head,base.group_system"/>
           
                <button name="action_custom_save"
                    string="Save"
                    type="object"
                    class="btn-secondary"/>


                <!-- Statusbar -->
                <field name="state" widget="statusbar" statusbar_visible="draft,under_repair,done,payment,released"/>
            </header>
        </xpath>


        <!-- Replace top section with coordinator-friendly layout -->
        <xpath expr="//form/sheet/group[1]" position="replace">

            <field name="customer_category" widget="radio" options="{'horizontal': true}" readonly="readonly_customer_info"/>
          
            <group class="oxord-card" colspan="2">

                <!-- Customer Information -->
                <group string = "Customer Info">
                  <field name="partner_id" string="Customer" readonly="readonly_customer_info"/>
                  <field name="contact_person_id" 
                        options="{'no_create': True}"
                        invisible="not show_contact_person"
                        readonly="readonly_customer_info"/>
                  <field name="company_category"
                        string="Company Type"
                        invisible="not show_company_type"
                        readonly="readonly_customer_info"/>
                  <field name="individual_type"
                        string="Individual Type"
                        invisible="not show_individual_type"
                        readonly="readonly_customer_info"/>
                </group>

                <!-- OXORD Info -->
                <group string="OXORD Info">
                    <field name="service_type" widget="radio" options="{'horizontal': true}" readonly="readonly_customer_info"/>
                    <field name="company_id" readonly="readonly_customer_info"/>
                        <!-- Branch -->
                    <field name="branch"
                           string="Branch"
                           required="1"
                           readonly="readonly_customer_info"/>
                </group>


            </group>
          
        </xpath>

        <xpath expr="//form/sheet/notebook" position="before">
            <group class="oxord-card" col="2">
                <!-- Left column: Department Info -->
                <group string="Department Info">
                    <field name="department_id" widget="radio" options="{'horizontal': true}" readonly="readonly_customer_info"/>
                    <field name="unit_type_id"
                           widget="radio"
                           options="{'horizontal': true, 'no_create': True}"
                           domain="[('department_id', '=', department_id)]"
                           readonly="readonly_customer_info"/>
                </group>
        
                <!-- Right column: Repair Info -->
                <group string="Repair Info" invisible="not show_repair_info">
                    <field name="is_rerepair" readonly="1"/>
                    <field name="original_repair_id" readonly="1" options="{'no_create': True}"/>
                </group>
            </group>


            <!-- Unit Information + Warranty Details Card -->
            <group class="oxord-card" colspan="2">
            
                <!-- Unit Information + Problems (Left Column) -->
                <group string="Unit Information">
                    <field name="brand_id" options="{'no_create': True}" readonly="readonly_customer_info"/>
                    <field name="model_id" string="Model" options="{'no_create': True}" readonly="readonly_customer_info"/>
                    <field name="serial" string="Serial"  readonly="readonly_customer_info"/>
                    <field name="accessory_ids" widget="many2many_tags"/>
                    <field name="password" string="Password"/>
            
                    <!-- Problem Info -->
                    <field name="problem_ids" widget="many2many_tags" options="{'no_create': True}" invisible="is_onsite"/>
                    <field name="problem_detail" placeholder="Describe the issue in detail" invisible="is_onsite"/>
                    <field name="estimated_cost" string="Problem Cost" readonly="1" invisible="is_onsite"/>
                </group>
            
                <!-- Warranty Details (Right Column) -->
                <group string="Warranty Details">
                    <field name="warranty_duration" readonly="state != 'draft'"/>
                    <field name="pop_date"
                           class="warranty_css_class"
                           widget="date"
                           options="{'datepicker': {'format': 'yyyy-MM-dd'}}"
                           readonly="state != 'draft'"/>
                    <field name="warranty_expiry_date" readonly="1" class="warranty_css_class"/>
                    <field name="warranty_status" widget="badge" readonly="1" class="warranty_css_class"/>
                    <field name="void_warranty" string="Void Warranty" class="o_field_inline" readonly="state != 'draft'"/>
                </group>
            
            </group>

            <!-- Side-by-side Receiving and Releasing Details -->
            <group class="oxord-card" colspan="2">

                <!-- Left column: Receiving Details -->
                <group string="Receiving Details">
                    <field name="received_date" string="Date and Time" readonly="readonly_customer_info"/>
                    <field name="received_by" string="Received By" required="1" readonly="readonly_customer_info"/>
                    <field name="remarks" string="Remarks"/>
                </group>

                <!-- Right column: Releasing Details -->
                <group string="Releasing Details" invisible="not show_releasing">
                    <field name="coordinator_id" readonly="1"/>
                </group>

            </group>

            <group class="oxord-card" colspan="2" string="Technician Assigned">
                <group>
                                
                    <field name="technician_line_ids" string="">
                        <list editable="bottom">
                            <field name="technician_id" string="Technician"/>
                            <field name="start_date" string="Start Date"/>
                            <field name="end_date" string="End Date"/>
                            <field name="aging_formatted" string="Aging"/>
                            <field name="action_taken" string="Action Taken"/>
                            <field name="remarks" string="Remarks"/>
                        </list>
                    </field>
                </group>
            </group>


            <group class="oxord-card" string="Aging Information" col="2"
                  groups="base.group_system">

              <!-- Left column: key dates -->
              <group>
                <field name="received_date" readonly="1"/>
                <field name="repair_start_date" readonly="1"/>
                <field name="repair_end_date" readonly="1"/>
                <field name="released_date" readonly="1"/>
              </group>

              <!-- Right column: formatted durations -->
              <group>
                <field name="total_aging_formatted" readonly="1"/>
                <field name="repair_duration_formatted" readonly="1"/>
                <field name="coordinator_to_release_formatted" readonly="1" string="Coordinator â†’ Release"/>

              </group>
            </group>
        </xpath>
          
      </field>
    </record>


  </data>
</odoo>
